# TASK-010 收藏与观影状态（想看/看过）能力补全

> 目标：把收藏与观影记录从“全局表/不隔离”升级为“按用户维度、可持久化同步、幂等、可回归”的条目行为体系。

## 任务内容
- 要做什么：
  - 收藏：按用户维度的收藏列表、收藏/取消收藏（幂等）、前端状态联动。
  - 观影状态：支持“想看/看过”标记；个人中心展示想看/看过列表（按时间倒序）。
  - 联动规则：用户提交短评/评分/影评时默认标记为“看过”（若此前为想看则切换）。
- 为什么要做（背景/问题）：
  - 当前收藏未绑定用户，跨用户不隔离，无法满足“更换设备同步”的基本诉求；也缺少豆瓣式“想看/看过”记录能力。
- 目标（可量化）：
  - 收藏与观影状态具备用户隔离与幂等；列表可分页（或至少支持稳定倒序）；状态与按钮展示一致。
- 范围（包含/不包含）：
  - 包含：后端数据模型与接口、前端按钮与列表页、与短评/影评的联动规则说明。
  - 不包含：推荐算法（另立任务）；管理员运营能力（另立任务）。

## 具体实施方案

### 数据模型（建议）
- 收藏：`user_favorite(userId, movieId, createdAt)`，并对 `(userId, movieId)` 做唯一性约束，保证幂等。
- 观影状态：`user_movie_status(userId, movieId, status, markedAt, createdAt, updatedAt)`，并对 `(userId, movieId)` 做唯一性约束。
- 状态枚举（建议最小集）：`WISH`（想看）、`WATCHED`（看过）。

### 接口契约（定版）
- 收藏（按当前登录用户维度；不接收 userId/username 参数）
  - 获取我的收藏列表（按 `createdAt` 倒序）：`GET /api/me/favorites` -> `List<Movie>`
  - 获取单片收藏状态：`GET /api/me/favorites/{movieId}` -> `{ favorited: boolean, createdAt: string | null }`
  - 添加收藏（幂等，保留首次收藏时间）：`PUT /api/me/favorites/{movieId}` -> `{ favorited: true, createdAt: string }`
  - 取消收藏（幂等）：`DELETE /api/me/favorites/{movieId}` -> `{ favorited: false, createdAt: null }`
- 观影状态（按当前登录用户维度；不接收 userId/username 参数）
  - 获取单片状态：`GET /api/me/movie-status/{movieId}` -> `{ status: 'WISH' | 'WATCHED' | null, markedAt: string | null }`
  - 设置状态（允许 `WATCHED <-> WISH` 双向切换；同状态重复设置保持 `markedAt` 不变）：`PUT /api/me/movie-status/{movieId}` body `{ status: 'WISH' | 'WATCHED' }`
  - 获取我的想看/看过列表（按 `markedAt` 倒序）：`GET /api/me/movie-status?status=WISH|WATCHED` -> `List<Movie>`

### 前端交互（建议最小闭环）
- 电影详情页：
  - “想看/看过/收藏”按钮展示当前状态并可切换。
  - 提交短评/评分/影评成功后，状态自动展示为“看过”。
- 个人中心：
  - “我的收藏 / 想看 / 看过”三类列表入口。
  - 列表项点击可跳转电影详情页。

### 步骤
1. 契约冻结：确定收藏与观影状态的接口、字段、排序与幂等策略。
2. 数据隔离落地：所有读写以当前登录用户为准（本阶段不做全局授权专项，需在本功能内保证“跨用户不可见/不可改”并配套测试）。
3. 收藏闭环：列表/添加/取消 + 前端状态联动。
4. 观影状态闭环：想看/看过标记 + 个人中心列表 + 与短评/影评联动规则。
5. 测试收口：补齐幂等、隔离、排序、联动的用例（与 `TASK-014` 对齐）。

## 过程验证
1. 收藏幂等
   - 观察/指标：同一用户对同一电影重复收藏不产生重复记录；重复取消不报错。
   - 通过标准：收藏列表中同一电影最多一条记录；状态显示一致。
2. 跨用户隔离
   - 观察/指标：A 的收藏/想看/看过列表不包含 B 的数据。
   - 通过标准：严格按 userId 隔离。
3. 排序与联动
   - 观察/指标：列表按时间倒序；提交短评/影评后状态自动切换为看过。
   - 通过标准：排序稳定；联动规则符合约定且可回归。

## 最终结果验证
- 验收项：
  - 收藏与观影状态（想看/看过）完整闭环可用。
  - 幂等与隔离正确。
  - 前端展示与后端状态一致。
- 回归范围：
  - 详情页按钮、个人中心列表、短评/影评提交流程的状态联动。

## 风险与回滚
- 风险点：
  - 存量收藏数据迁移成本；状态联动导致用户感知变化；分页与排序口径不一致。
- 规避手段：
  - 迁移策略先文档定版；前端提示清晰；统一排序字段；补齐回归用例。
- 回滚策略：
  - 保留旧收藏读取接口一段时间作为兼容；新写入只写新表，避免双写复杂度（按评审定版）。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 依赖：无（假设现有登录态可用；测试与回归口径对齐 `TASK-014`）
- 对应 Issue：待补充
- 相关 PR：待补充
