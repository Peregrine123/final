# TASK-013 搜索增强与推荐（多维搜索/自动补全/可解释推荐）

> 目标：在不引入重型大数据依赖的前提下，补齐豆瓣式影评系统常用的“找电影”能力：多维搜索、自动补全、推荐与相关推荐。

## 任务内容
- 要做什么：
  - 搜索增强：
    - 支持多条件组合（关键词、分类、主演/导演、年份区间等，按评审定版）。
    - 明确排序规则（相关性/时间/热度的优先级）。
  - 自动补全（suggest）：
    - 输入到一定长度后返回候选（标题/演员等）。
    - 有频控与最小输入长度，避免成为热点压测入口。
  - 推荐：
    - 首页推荐：新用户默认推荐；登录用户基于收藏/想看/看过/短评/影评的轻量推荐。
    - 相关推荐：电影详情页按“同分类/相似标签/热度相近”等可解释规则给出列表。
- 为什么要做（背景/问题）：
  - 当前仅有关键词搜索（按标题/主演模糊匹配），缺少多维筛选与自动补全；推荐缺失。
- 目标（可量化）：
  - 多维搜索可用且结果稳定；补全接口在可接受延迟内返回；推荐结果可解释且可回归。
- 范围（包含/不包含）：
  - 包含：搜索接口扩展、补全接口、新推荐接口与前端展示、测试与验收口径。
  - 不包含：复杂画像/深度学习推荐、离线计算平台（后续另立任务）。

## 具体实施方案

### 搜索（多维）
- 参数策略：
  - 明确每个参数的类型与边界（例如年份区间、分类 id、关键词长度）。
  - 空参数行为：默认回退到列表或热门排序（需定版）。
- 排序策略（建议最小可解释）：
  - 关键词相关性优先（可用简单规则：标题命中 > 演员命中 > 简介命中）。
  - 无关键词时按时间或热度（若无热度字段，可用“新增时间/ID”近似）。

### 自动补全
- 候选来源：标题、演员/导演字段（按现有字段能力定版）。
- 限制策略：
  - 最小输入长度；
  - 限流/频控（IP 维度 + 用户维度）；
  - 返回条数上限，防止拖慢与信息泄露。

### 推荐（轻量可解释）
- 新用户：按“热门/最新/编辑精选（手工配置）”兜底（需定版口径）。
- 登录用户：按“最近看过/想看/收藏/评分行为”统计偏好，推荐同类电影：
  - 分类优先：常看分类/常收藏分类；
  - 其次：演员/导演关键词（若字段具备）。
- 相关推荐：同分类 + 时间相近/ID 相近作为最小实现，保证稳定与可回归。

### 步骤
1. 契约冻结：定版搜索参数、补全规则、推荐规则与排序策略。
2. 搜索增强落地：多参数组合搜索与排序规则。
3. 自动补全落地：候选来源 + 限流策略 + 前端交互。
4. 推荐落地：首页推荐 + 详情相关推荐（可解释规则）。
5. 测试收口：搜索正确性、补全边界、推荐稳定性与性能回归（与 `TASK-014` 对齐）。

## 过程验证
1. 搜索正确性
   - 观察/指标：组合条件能正确过滤；参数非法有统一错误语义；排序稳定。
   - 通过标准：主要搜索场景与边界场景均通过测试用例。
2. 自动补全体验与安全
   - 观察/指标：输入过短不触发；触发后返回候选可点击填充；高频触发被限流。
   - 通过标准：接口稳定，不因补全导致明显性能问题或信息泄露。
3. 推荐可解释性
   - 观察/指标：新用户有默认推荐；老用户推荐与其行为有可解释关联（例如同分类占比）。
   - 通过标准：推荐结果可回归、稳定且不为空（除非数据库无数据）。

## 最终结果验证
- 验收项：
  - 多维搜索与自动补全可用；推荐可用且可解释。
  - 关键边界用例与性能风险点有回归覆盖。
- 回归范围：
  - 搜索页/列表页、补全交互、首页推荐模块、详情相关推荐模块。

## 风险与回滚
- 风险点：
  - 搜索参数过多导致接口复杂；补全接口被滥用；推荐规则不稳定导致难以回归。
- 规避手段：
  - 先定 MVP 参数集；补全强制限流；推荐规则保持可解释与确定性。
- 回滚策略：
  - 可配置关闭补全与推荐，回退到基础关键词搜索与普通列表。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 依赖：`docs/task/TASK-010-favorites-and-watch-status.md`、`docs/task/TASK-011-short-reviews-and-ratings.md`、`docs/task/TASK-012-user-long-reviews.md`（推荐可利用用户行为）
- 对应 Issue：待补充
- 相关 PR：待补充
