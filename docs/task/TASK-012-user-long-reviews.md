# TASK-012 用户影评（长评）能力补全（草稿/发布/展示/内容安全）

> 目标：落地“用户写影评（长评）”闭环：写作体验、草稿、发布、审核可见性、权限边界、内容安全。

## 任务内容
- 要做什么：
  - 影评写作：支持 Markdown/富文本写作与预览（按评审定版）；支持草稿保存。
  - 发布与状态机：草稿 -> 待审 -> 通过/驳回；对外仅展示“通过”的影评；作者可见自己全部状态。
  - 展示：
    - 电影详情页：影评列表（分页/排序）与影评详情。
    - 个人中心：我的影评列表（含草稿/待审/已通过）。
  - 权限：作者仅能编辑/删除自己的影评；他人不可见草稿/待审/驳回内容。
  - 内容安全：XSS 防护、外链与外部图片策略（对齐 `TASK-007`）、长度限制与频控。
- 为什么要做（背景/问题）：
  - 当前系统已有“管理员博客/文章”，但缺少“普通用户影评（长评）”的数据归属、可见性与写作闭环。
- 目标（可量化）：
  - 用户可完成“草稿 -> 发布 ->（通过后）对外可见”的闭环；权限边界严格；无明显 XSS 风险；测试可回归。
- 范围（包含/不包含）：
  - 包含：长评的数据模型、接口、前端写作与展示、最小审核状态机。
  - 不包含：完整的管理员审核后台（可另立任务）；但需预留审核入口与权限点位。

## 具体实施方案

### 方案选择（需评审定版）
- 方案 A：新增独立影评表 `movie_review`
  - 优点：语义清晰、用户归属明确、与电影关联简单。
  - 风险：需要新的一套列表/详情/编辑逻辑与测试。
- 方案 B：复用既有文章体系（BlogArticle）并扩展字段（author/movie/status）
  - 优点：复用编辑器与文章展示能力。
  - 风险：需要清晰区分“管理员博客”与“用户影评”，避免权限混乱与数据污染。

### 核心规则（建议）
- 发布影评后，联动把观影状态置为“看过”（对齐 `TASK-010`）。
- 可见性：
  - 对外：仅 `APPROVED`。
  - 作者：可见全部状态（草稿/待审/通过/驳回）。
- 排序：默认按发布时间倒序；草稿按更新时间倒序。
- 频控：同一用户单位时间发布/提交次数限制，避免刷屏与资源滥用。

### 内容安全（必须定版）
- 渲染策略：Markdown/富文本渲染必须确保不执行脚本；外链与图片白名单策略对齐 `TASK-007` 的结论。
- 输入限制：标题/正文长度、图片数量、外链数量（按评审定版）。

### 步骤
1. 方案评审：A/B 二选一并冻结数据模型与接口。
2. 接口与状态机：草稿保存、提交发布、详情与列表接口；对齐现有登录态，并在本功能内保证作者权限边界与可见性规则（测试口径对齐 `TASK-014`）。
3. 前端写作体验：编辑器、草稿列表、发布提示与状态展示。
4. 前端展示：电影详情影评列表、影评详情页、个人中心我的影评。
5. 内容安全与测试：XSS/外链/图片策略落地；补齐自动化与手工安全回归。

## 过程验证
1. 草稿与发布闭环
   - 观察/指标：草稿可保存与再次编辑；提交后进入待审；通过后在电影详情页可见。
   - 通过标准：状态机流转正确；作者/他人看到的内容符合可见性规则。
2. 权限边界
   - 观察/指标：非作者无法编辑/删除；未登录无法创建；他人无法访问草稿与待审内容。
   - 通过标准：越权路径被完全封堵（需有自动化测试覆盖）。
3. 内容安全
   - 观察/指标：包含脚本/危险标签的影评不会执行；外部图片链接符合策略或被拦截/替换。
   - 通过标准：无明显 XSS 执行路径；策略可回归。

## 最终结果验证
- 验收项：
  - 用户影评（长评）完整闭环可用；权限与可见性规则严格；内容安全策略生效。
  - 关键用例（草稿/发布/展示/越权/XSS）均可回归。
- 回归范围：
  - 影评编辑器、影评列表/详情、个人中心我的影评、与观影状态联动。

## 风险与回滚
- 风险点：
  - 复用文章体系导致权限混乱；外链/图片策略不当导致安全风险；审核缺失导致不当内容外显。
- 规避手段：
  - 方案评审定版；默认待审；严格渲染与白名单；安全用例纳入发布阻断。
- 回滚策略：
  - 临时关闭影评发布入口（仅保留展示“通过”内容）；保留数据不删除，待修复后恢复。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 依赖：`docs/task/TASK-010-favorites-and-watch-status.md`
- 参考：`docs/task/TASK-007-remote-image-audit.md`
- 对应 Issue：待补充
- 相关 PR：待补充
