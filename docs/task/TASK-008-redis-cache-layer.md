# TASK-008 Redis 缓存层实施计划

> 目标：在不改动现有业务逻辑的前提下，为后端引入 Redis 缓存层，降低热点读请求的数据库压力，并确保写入后数据一致性与可回退能力。

## 任务内容
- 要做什么：
  - 在后端引入 Redis 作为缓存层，并通过统一缓存策略覆盖热点读接口（电影/影单/分类/博客列表等）。
  - 设计缓存键、TTL、序列化方式、缓存失效与回退策略。
  - 增加可配置开关，支持在 Redis 不可用时自动降级为数据库直读。
- 为什么要做（背景/问题）：
  - 当前读请求全部直连数据库，列表类接口容易成为热点，影响响应时间与并发能力。
  - 本项目已引入 Redis 依赖但未形成实际缓存层，存在“配置有但未落地”的空白。
- 目标（可量化）：
  - 热点读接口在正常情况下缓存命中率达到 70%+。
  - 读接口平均响应时间可感知下降（以稳定环境对比为准）。
  - 缓存失效后数据一致性可在可接受范围内（写入后在一个 TTL 周期内不出现明显脏读）。
- 范围（包含/不包含）：
  - 包含：后端缓存层设计、配置、关键读接口缓存、写入操作的缓存失效。
  - 不包含：前端改造、Redis 集群/高可用架构、分布式锁与复杂一致性事务。
- 影响面（模块/接口/数据/用户）：
  - 模块：`service` 层方法、缓存配置模块、可选健康检查。
  - 接口：电影/影单/分类列表、博客列表/详情等读接口。
  - 数据：Redis 中新增缓存数据，数据库仍为唯一可信源。
  - 用户：读性能提升；写后短期内可能受 TTL 影响的缓存一致性。

## 具体实施方案
采用 Spring Cache + Redis 的统一缓存层，优先在 `service` 层进行方法级缓存。缓存键按“业务前缀 + 参数”规则生成，避免跨模块冲突；对写操作采用“精确失效 + 兜底清理”的组合策略；在 Redis 不可用时自动降级到数据库直读。

### 缓存策略与关键决策
- 缓存范围：
  - 列表类：电影列表、影单列表、分类列表、博客分页列表。
  - 详情类：博客详情（按 id）。
  - 搜索类：默认不缓存（关键词组合高基数），如需缓存则设置短 TTL 与长度门槛。
- 失效策略：
  - 发生新增/更新/删除时，精准清理相关缓存；必要时清理同模块的“列表缓存”。
- TTL 策略：
  - 列表/分类：中等 TTL，保证数据更新后可在合理时间内刷新。
  - 详情：略短 TTL，避免长时间脏读。
- 兼容性策略：
  - Redis 不可用时自动回退到 DB；缓存层不影响主链路可用性。
- 序列化策略：
  - 统一 JSON 序列化，确保可读性与跨版本兼容性。

### 步骤
1. 需求与热点分析：确认哪些读接口最热点、写入频率与一致性需求。
2. 设计缓存键/TTL/失效策略：明确每个缓存的 key 规则、TTL、写入后的清理范围。
3. 完成缓存配置与基础设施：启用缓存管理、Redis 连接参数、序列化与命名空间。
4. 落地到 service 层：为目标方法添加缓存与失效策略；保持 controller 逻辑不变。
5. 增加可配置开关与降级策略：Redis 异常时自动 fallback；必要时支持手动关闭缓存。
6. 形成验证记录与最终验收口径：对齐“过程验证/最终结果验证”。

## 过程验证
1. 验证点：缓存命中与降级
   - 观察/指标：热点接口在多次请求后出现命中迹象；Redis 不可用时请求仍可完成。
   - 通过标准：缓存命中后响应时间有明显改善；Redis 断开时仍能正确返回数据。
2. 验证点：写后一致性
   - 观察/指标：新增/更新/删除后，对应列表或详情能在合理时间内反映变更。
   - 通过标准：写操作后缓存正确失效；不会长期返回旧数据。
3. 验证点：缓存键覆盖
   - 观察/指标：列表/详情相关缓存键可被唯一定位，且无跨模块冲突。
   - 通过标准：缓存命中与失效行为符合设计策略。

## 最终结果验证
- 验收项：
  - 热点读接口已接入缓存。
  - 写操作可触发相关缓存失效。
  - Redis 不可用时仍能正常读写。
- 通过标准：
  - 缓存命中率达到预期；接口功能与数据正确性不受影响。
- 回归范围：
  - 电影/影单/分类/博客相关接口的读取与写入流程。

## 风险与回滚
- 风险点：
  - 缓存不一致导致短期脏读；缓存键设计不当导致误命中或冲突；缓存雪崩与穿透。
- 规避手段：
  - TTL 分层、失效范围控制、关键接口可配置跳过缓存；必要时加入随机抖动。
- 回滚策略（描述思路即可）：
  - 通过配置关闭缓存或回退到 DB 直读，不影响业务主流程。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：2026-01-24

## 关联信息
- 对应 Issue：待补充
- 相关 PR：待补充
- 其他资料链接：待补充
