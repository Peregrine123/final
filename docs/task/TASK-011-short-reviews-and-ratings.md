# TASK-011 短评与评分（内容安全/可见性/最小审核）

> 目标：落地豆瓣式“短评 + 评分”基础能力，并保证内容安全、可见性规则与可回归测试。

## 任务内容
- 要做什么：
  - 评分：支持 1-5 星（或 0.5 步进按评审定版）的评分提交与展示。
  - 短评：支持对电影发布短评；电影详情页展示短评列表（分页/排序）。
  - 可见性：引入最小审核状态机（待审/通过/驳回）；对外仅展示“通过”的短评；作者可看到自己的待审。
  - 互动（增强项）：点赞短评（幂等），回复作为后续增强。
  - 内容安全：输入限制、敏感词/长度/XSS 防护策略文档化与测试化。
- 为什么要做（背景/问题）：
  - 当前短评/评分在前端为演示 mock 数据，缺少真实数据闭环与审核机制。
- 目标（可量化）：
  - 用户可发布评分与短评；列表稳定分页；可见性规则严格；无明显 XSS 风险；有自动化测试覆盖。
- 范围（包含/不包含）：
  - 包含：短评与评分的数据模型、接口、前端展示、审核状态机（最小版）。
  - 不包含：管理员侧审核后台（可先由管理员接口/脚本/手工 DB 操作过渡，但需在文档说明；正式后台另立任务）。

## 具体实施方案

### 数据与规则
- 数据模型建议：`movie_comment(movieId, userId, rating, content, status, createdAt, updatedAt)`。
- 核心规则（建议）：
  - 未登录不可发布。
  - 发布短评/评分成功后，联动把观影状态置为“看过”（由 `TASK-010` 统一规则）。
  - 对外展示：仅 `status=APPROVED` 可见；作者可见自己的全部状态。
  - 排序：默认按时间倒序；评分聚合（均分/人数）作为增强项。

### 内容安全策略（必须定版）
- 输入限制：
  - 内容长度上下限；空内容是否允许（仅评分/仅短评按评审定版）。
  - 频控：同一用户短时间内发布频率限制，避免刷屏。
- XSS 防护：
  - 后端存储时进行清洗或转义策略定版；
  - 前端展示端不执行任何脚本型内容。
- 文案策略：
  - 失败提示应清晰但不暴露内部审核规则细节（避免被绕过）。

### 步骤
1. 契约冻结：确定评分范围、短评字段、分页与排序、审核状态与可见性规则。
2. 数据与接口：新增短评/评分读写接口；对齐现有登录态，并在本功能内保证“跨用户不可改/待审对外不可见”等边界（测试口径对齐 `TASK-014`）。
3. 前端展示：详情页短评列表与发布入口；个人中心“我的短评”入口（可选）。
4. 内容安全：输入校验 + XSS 策略定版；补齐测试。
5. （增强）点赞：幂等与计数一致性规则定版并测试化。

## 过程验证
1. 发布与联动
   - 观察/指标：发布短评/评分成功；观影状态自动变为看过；个人中心可见自己的待审记录。
   - 通过标准：联动生效；作者与他人看到的内容符合可见性规则。
2. 可见性与审核
   - 观察/指标：待审/驳回内容对外不可见；通过内容对外可见且可分页。
   - 通过标准：无越权可见性漏洞；列表稳定。
3. 内容安全
   - 观察/指标：包含脚本/危险标签的输入不会在页面执行；后端拒绝或安全降级展示。
   - 通过标准：无明显 XSS 执行路径；边界输入处理一致。

## 最终结果验证
- 验收项：
  - 短评/评分闭环可用；可见性规则严格；内容安全策略生效。
  - 自动化用例覆盖发布/展示/可见性/安全边界。
- 回归范围：
  - 电影详情页短评模块；短评发布；短评列表分页；观影状态联动。

## 风险与回滚
- 风险点：
  - 审核机制缺失导致不当内容外显；频控不足导致刷屏；XSS 风险。
- 规避手段：
  - 默认待审；频控可配置；严格的安全渲染；发布前安全用例阻断。
- 回滚策略：
  - 临时关闭短评发布入口（仅保留展示）并保留数据；或仅展示“通过”内容。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 依赖：`docs/task/TASK-010-favorites-and-watch-status.md`
- 对应 Issue：待补充
- 相关 PR：待补充
