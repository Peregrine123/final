# TASK-011 短评与评分（内容安全/直接发布）

> 目标：落地豆瓣式“短评 + 评分”基础能力，并保证内容安全、可见性规则与可回归测试。

## 任务内容
- 要做什么：
  - 评分：支持 1-5 星（或 0.5 步进按评审定版）的评分提交与展示。
  - 短评：支持对电影发布短评；电影详情页展示短评列表（分页/排序）。
  - 互动（增强项）：点赞短评（幂等），回复作为后续增强。
  - 内容安全：输入限制、敏感词/长度/XSS 防护策略文档化与测试化。
- 为什么要做（背景/问题）：
  - 当前短评/评分在前端为演示 mock 数据，缺少真实数据闭环。
- 目标（可量化）：
  - 用户可发布评分与短评；列表稳定分页；无明显 XSS 风险；有自动化测试覆盖。
- 范围（包含/不包含）：
  - 包含：短评与评分的数据模型、接口、前端展示、点赞、内容安全与测试。
  - 不包含：管理员侧审核后台（本版本为“直接发布”，如需审核另立任务）。

## 具体实施方案

### 数据与规则
- 数据模型建议：`movie_comment(movieId, userId, rating, content, status, createdAt, updatedAt)`（本版本 `status` 统一为 `APPROVED`，为后续扩展预留字段）。
- 核心规则（建议）：
  - 未登录不可发布。
  - 发布短评/评分成功后，联动把观影状态置为“看过”（由 `TASK-010` 统一规则）。
  - 对外展示：直接发布，所有短评对外可见（按时间倒序分页）。
  - 排序：默认按时间倒序；评分聚合（均分/人数）作为增强项。

### 接口契约（已落地）
- 我的短评/评分（按当前登录用户维度；不接收 userId/username 参数）
  - 获取我的短评：`GET /api/me/movie-comments/{movieId}` -> `MovieCommentDto`
  - 提交/更新我的短评（幂等更新，同内容/评分重复提交不改变状态与时间）：`PUT /api/me/movie-comments/{movieId}` body `{ rating?: 1..5, content?: string }` -> `MovieCommentDto`
- 电影短评列表（直接发布）
  - 获取短评列表（分页，默认时间倒序）：`GET /api/movies/{movieId}/comments?page=1&size=10` -> `{ items, total, page, size }`
    - 每条短评包含：`likeCount`、`likedByMe`
  - 评分汇总：`GET /api/movies/{movieId}/rating-summary` -> `{ average: number|null, count: number }`（统计所有“有评分”的短评）
- 点赞（按当前登录用户维度，幂等）
  - 获取我对某条短评的点赞状态：`GET /api/me/movie-comment-likes/{commentId}` -> `{ liked: boolean, likeCount: number }`
  - 点赞：`PUT /api/me/movie-comment-likes/{commentId}` -> `{ liked: true, likeCount: number }`
  - 取消点赞：`DELETE /api/me/movie-comment-likes/{commentId}` -> `{ liked: false, likeCount: number }`

### 内容安全策略（必须定版）
- 输入限制：
  - 允许“仅评分”或“仅短评”，但两者不能同时为空。
  - 评分范围：1-5（整数）。
  - 短评最大长度：280（超出返回 400）。
  - 频控：同一用户短时间内更新/发布短评会触发 429（默认 10 秒，可配置）。
- XSS 防护：
  - 后端对短评内容进行最小清洗：去除所有 HTML 标签（避免明显 XSS 载荷）；
  - 前端展示端不执行任何脚本型内容。
- 文案策略：
  - 失败提示应清晰但不暴露内部校验/风控规则细节（避免被绕过）。

### 可配置项（application.properties）
- `blc.comment.max-length`：短评最大长度，默认 `280`
- `blc.comment.rate-limit-seconds`：频控秒数，默认 `10`
- `blc.comment.blocked-words`：敏感词（逗号分隔），默认空（例如：`badword,fuck,傻逼`）

### 步骤
1. 契约冻结：确定评分范围、短评字段、分页与排序。
2. 数据与接口：新增短评/评分读写接口；对齐现有登录态，并在本功能内保证“跨用户不可改”等边界（测试口径对齐 `TASK-014`）。
3. 前端展示：详情页短评列表与发布入口；个人中心“我的短评”入口（可选）。
4. 内容安全：输入校验 + XSS 策略定版；补齐测试。
5. （增强）点赞：幂等与计数一致性规则定版并测试化。

## 过程验证
1. 发布与联动
   - 观察/指标：发布短评/评分成功；观影状态自动变为看过；短评可分页展示。
   - 通过标准：联动生效；列表稳定。
2. 内容安全
   - 观察/指标：包含脚本/危险标签的输入不会在页面执行；后端拒绝或安全降级展示。
   - 通过标准：无明显 XSS 执行路径；边界输入处理一致。

## 最终结果验证
- 验收项：
  - 短评/评分闭环可用；直接发布；内容安全策略生效；点赞可用且幂等。
  - 自动化用例覆盖发布/展示/点赞/安全边界。
- 回归范围：
  - 电影详情页短评模块；短评发布；短评列表分页；观影状态联动。

## 风险与回滚
- 风险点：
  - 频控不足导致刷屏；XSS 风险；不当内容外显（因为直接发布）。
- 规避手段：
  - 频控可配置；严格的安全渲染；发布前安全用例阻断；必要时可快速关闭发布入口。
- 回滚策略：
  - 临时关闭短评发布入口（仅保留展示）并保留数据。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 依赖：`docs/task/TASK-010-favorites-and-watch-status.md`
- 对应 Issue：待补充
- 相关 PR：待补充
