# TASK-014 测试策略与发布回归 Runbook（用户侧功能）

> 目标：为用户侧（条目行为/短评/影评/搜索推荐）提供统一、可重复、可留痕的测试流程，避免“靠感觉验收”。
>
> 说明：账号体系安全增强与全局隐私/越权专项本阶段不做（不纳入阻断级测试范围），默认沿用现有登录能力作为测试前置条件。

## 任务内容
- 要做什么：
  - 统一测试分层与阻断标准：单元/集成/API/E2E/手工安全回归的职责边界。
  - 统一测试数据口径：最小数据集、账号集、重置策略（保证可复现）。
  - 输出发布前必跑 Runbook：每次发布前按同一顺序执行并记录结果。
  - 维护“发布阻断级用例矩阵（P0/P1）”：任何 P0 失败禁止发布。
- 为什么要做（背景/问题）：
  - 用户侧功能涉及鉴权、可见性、内容安全，回归风险高；缺少统一流程会导致安全缺陷与体验回归。
- 范围（包含/不包含）：
  - 包含：用户侧功能相关测试流程与验收口径；不写任何脚本/命令，仅描述流程与标准。
  - 不包含：性能压测平台搭建、全链路监控平台建设（可后续补充）。

## 具体实施方案

### 测试分层与职责
- 单元测试（逻辑层）：
  - 目标：覆盖规则与边界（例如状态机流转、可见性判断、输入校验）。
- 集成/API 测试（接口层）：
  - 目标：覆盖鉴权、资源归属校验、幂等性、分页排序、错误码语义。
- E2E（关键路径）：
  - 目标：覆盖用户端“登录（前置）->想看/看过/收藏->短评/影评->搜索/推荐”的主链路。
- 手工安全回归：
  - 目标：模拟越权、枚举、XSS 载荷、频控绕过等“自动化不容易覆盖/或需要人工复核”的场景。

### 阻断标准（建议）
- P0：安全与可见性（跨用户数据泄露/越权修改、待审/驳回内容对外可见、XSS 可执行）任何一项失败 => 禁止发布。
- P1：核心功能闭环（收藏、想看/看过、短评、影评、搜索）失败 => 禁止发布或需评审签字放行。
- P2：体验增强（补全/推荐优化、UI 细节）失败 => 可带缺陷发布但必须记录与排期修复。

### 统一测试数据口径（最小集合）
- 账号：
  - 用户 A
  - 用户 B（用于验证跨用户隔离与权限边界）
- 电影数据：
  - 至少 2 个分类、若干电影（用于覆盖有/无短评、有/无影评、有/无收藏/想看/看过）
- 内容样例：
  - 正常文本、超长文本、包含特殊字符文本、包含典型 XSS 载荷的文本（用于安全回归）
- 重置策略：
  - 每次测试前必须确保数据集一致（全量重建或可控清理），避免“依赖上一次残留状态”。

### 发布前必跑 Runbook（执行顺序与留痕要求）
1. 环境确认
   - 确认测试环境配置一致、数据集已重置。
2. 自动化测试执行
   - 执行单元与集成/API 测试套件；记录通过/失败用例。
3. E2E 或手工主链路回归
   - 覆盖：想看/看过、收藏、短评、影评、搜索/补全/推荐（登录作为前置条件，不在本轮回归范围）。
4. 手工安全回归（P0 必跑）
   - 越权读写：收藏/想看看过/短评/影评（含草稿/待审内容）
   - 可见性：待审/驳回内容外部不可见
   - XSS：输入载荷在展示端不可执行
5. 结果记录与发布结论
   - 记录版本号、执行人、执行时间、失败项、缺陷链接、是否允许发布的结论（含阻断标准依据）。

## 过程验证
1. 流程可复现性
   - 观察/指标：不同成员按同一 Runbook 执行，结果一致且可解释。
   - 通过标准：流程步骤清晰，无依赖“口口相传”的隐含知识。
2. 阻断有效性
   - 观察/指标：故意引入典型越权或 XSS 场景时，用例能稳定发现。
   - 通过标准：P0 用例能拦截高危缺陷进入发布。

## 最终结果验证
- 验收项：
  - 测试分层、阻断标准、数据口径、Runbook 全部定版并可执行。
  - 与 `TASK-010~TASK-013` 的验收项一一对齐，形成发布前统一回归入口。
- 回归范围：
  - 用户侧主链路（条目行为/短评/影评/搜索推荐）。

## 风险与回滚
- 风险点：
  - 流程过重导致执行成本高；数据集不稳定导致用例漂移；测试环境不一致导致结果不可复现。
- 规避手段：
  - 明确 P0/P1/P2；最小数据集；发布前强制执行 Runbook 并留痕。
- 回滚策略：
  - 若流程过重，先保留 P0/P1 必跑集合，P2 作为按需执行；仍需留痕。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止：待补充（建议与 Epic 的里程碑同步）

## 关联信息
- 上游 Epic：`docs/task/TASK-009-user-features-completion-and-test-plan.md`
- 关联任务：`docs/task/TASK-010-favorites-and-watch-status.md`、`docs/task/TASK-011-short-reviews-and-ratings.md`、`docs/task/TASK-012-user-long-reviews.md`、`docs/task/TASK-013-search-and-recommendations.md`
