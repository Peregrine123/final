# TASK-009 用户侧功能补全与测试体系建设

> 背景：当前仓库已具备基础登录/注册、电影列表/分类/搜索（关键词）、电影详情页（前端按列表过滤）、个人资料查看与编辑、收藏（但未按用户隔离）等能力；但对照最初需求，用户侧仍存在安全、隐私、交互闭环缺口。本任务用于一次性规划“用户侧未完成能力”的落地路线，并建立可重复、可审计的测试流程，保证后续迭代质量。

## 任务内容
- 要做什么：
  - 补齐用户侧尚未完成/仅部分实现的功能闭环（账号安全、隐私隔离、收藏与历史、评论评分、观影与续看、搜索增强、推荐）。
  - 形成一套“严密、可执行、可回归”的测试流程（后端为主，覆盖关键前端链路），并给出验收口径与回归范围。
- 为什么要做（背景/问题）：
  - 当前实现存在“能用但不完整/不安全”的典型问题：邮箱唯一性缺失、登录防爆破缺失、2FA/找回密码缺失、个人资料可越权访问风险、收藏未按用户隔离、缺少观影历史与评论评分闭环。
  - 缺少系统化测试流程，后续功能一旦新增，容易引入回归与安全缺陷。
- 目标（可量化）：
  - 账号体系：注册支持邮箱唯一性；登录支持“用户名或邮箱”；登录失败限制与锁定策略生效；找回密码流程闭环；2FA（可选）闭环。
  - 数据隔离：个人资料、收藏、历史、评论等接口做到“仅本人可见/可改”，并有覆盖测试。
  - 交互闭环：用户能够完成“找电影 -> 查看详情 -> 收藏/评分/评论 -> 产生历史 -> 续看/推荐”的基础链路。
  - 测试：形成后端自动化测试用例集合（覆盖核心接口与安全边界）；形成前端关键路径的端到端（E2E）验证清单与手工回归清单；每次发布可按同一流程复验。
- 范围（包含/不包含）：
  - 包含：后端接口与数据模型调整（含必要索引/约束）、前端页面与交互补齐、测试用例与测试流程文档化、验收与回归清单。
  - 不包含（可拆到后续任务）：管理员侧“评论审核后台/封禁用户/投诉处理/报表系统”等（除非为用户侧闭环必须的最小能力）。
- 影响面（模块/接口/数据/用户）：
  - 模块：`controller/service/dao/pojo/config`；前端 `views/components/router/store`。
  - 接口：鉴权、用户资料、收藏、历史、评论评分、搜索、推荐、播放资源相关接口。
  - 数据：`user` 表新增唯一性约束与安全字段；新增收藏/历史/评论评分等表（或改造既有 `collection`）。
  - 用户：功能更完整；安全策略可能带来“登录更严格/需要额外验证”的体验变化，需要清晰提示与降摩擦设计。

## 具体实施方案

### 总体策略（分阶段交付）
为降低风险并保证每步可独立验证，采用“账号与安全优先 -> 数据隔离 -> 互动闭环 -> 增强体验”的分阶段交付：
1. 账号与安全（注册/登录/找回/2FA/防爆破）
2. 数据隔离（用户资料、收藏、历史、评论的访问控制）
3. 互动闭环（收藏按用户、观影历史、评论评分）
4. 观影与续看（播放入口、进度记录、续看）
5. 搜索增强与推荐（多维搜索、自动补全、个性化/相似推荐）

### 功能项拆解与设计要点

#### A. 用户注册补全（邮箱唯一性 + 安全校验）
- 需求点：
  - 注册时支持填写邮箱；邮箱必须唯一（与“用户名唯一”同等级）。
  - 密码安全存储已具备，但需补齐密码强度与输入校验、错误提示一致性。
- 设计要点：
  - 后端：增加“邮箱存在性检查”能力；注册时同时校验用户名与邮箱；明确错误码与错误文案策略（面向前端统一处理）。
  - 数据库：对 `user.email` 增加唯一性约束（需要同时考虑空值处理策略，避免“多个空邮箱导致唯一约束冲突”或“空值绕过唯一性”带来的不一致）。
  - 安全：对注册接口引入基本频控（避免脚本批量注册）。
- 验收口径：
  - 同一邮箱重复注册被拒绝；错误提示明确；不会影响仅用户名注册的既有流程（若允许邮箱为空，需定义清晰规则）。

#### B. 用户登录补全（用户名/邮箱登录 + 失败限制 + 2FA）
- 需求点：
  - 支持“用户名或邮箱 + 密码”登录。
  - 登录失败次数限制，防止暴力破解。
  - 支持双因素认证（2FA）提升安全性（可选启用）。
- 设计要点：
  - 登录标识符：在后端统一抽象为“identifier”，可解析为 username 或 email；匹配到唯一用户后进行密码校验。
  - 失败限制：
    - 账户维度：同一账户在窗口期内多次失败触发短期锁定。
    - IP 维度：同一 IP 在窗口期内多次失败触发节流或临时封禁（避免攻击者换用户名打点）。
    - 解锁策略：锁定到期自动解锁；成功登录清零失败计数；提示文案避免信息泄露（不要暴露“该邮箱是否存在”）。
  - 2FA（建议 TOTP）：
    - 启用流程：用户在个人资料/安全设置中开启 2FA；完成一次性验证后生效。
    - 登录流程：若用户已启用 2FA，密码正确后进入“二次验证挑战态”，验证通过才建立会话。
    - 兜底：提供恢复码或关闭流程（避免用户丢失设备永久无法登录），并定义最小风控校验。
- 验收口径：
  - 同一用户连续失败达到阈值后被锁定，锁定期内正确密码也无法登录；到期可恢复。
  - 启用 2FA 后，登录必须完成二次验证；未启用不受影响。

#### C. 忘记密码/重置密码（用户体验必需）
- 需求点：
  - 登录页提供“忘记密码”入口。
  - 通过邮箱完成密码重置。
- 设计要点：
  - 令牌机制：一次性、短时有效、不可预测；与用户、使用次数、过期时间绑定。
  - 邮件投递：支持开发环境可观测（例如本地落盘/控制台可视化/测试替身），避免测试依赖真实外部邮箱。
  - 安全：请求重置接口需要频控；返回文案避免泄露账户存在性；重置成功后使旧令牌失效。
- 验收口径：
  - 用户可完成“发起重置 -> 收到重置入口 -> 设置新密码 -> 使用新密码登录”的闭环；旧密码失效。

#### D. 个人资料编辑的隐私与越权防护（必须优先修复）
- 现状风险：
  - 当前存在通过传入他人 `id` 读取/修改用户资料的潜在越权风险（属于高优先级安全缺陷）。
- 设计要点：
  - 后端：以“当前登录用户”为准，提供“我的资料”接口，禁止按任意 `id` 修改他人信息。
  - 前端：路由从“带 id 的编辑页”调整为“编辑我的资料”，减少越权入口；同时在 UI 层对敏感字段显示与编辑做最小化。
  - 审计：记录关键变更（邮箱/密码/2FA 开关）以便追溯（可先落为数据库日志或应用日志策略）。
- 验收口径：
  - 非本人无法读取/更新他人资料；相关接口返回明确的未授权/禁止访问语义；有对应自动化测试覆盖。

#### E. 收藏功能修正为“按用户维度持久化同步”
- 现状问题：
  - 当前收藏数据未与用户绑定，跨用户不隔离，无法满足“更换设备也能同步”的需求。
- 设计要点：
  - 数据模型：收藏应以“用户 + 电影”为主键语义（避免复制一份电影字段导致一致性问题）。
  - 接口语义：收藏添加/取消应具备幂等性（重复添加不应产生重复记录）。
  - 前端：详情页与列表页的“收藏按钮”应与收藏状态联动；收藏列表展示按时间倒序。
- 验收口径：
  - 不同用户收藏互不影响；同一用户跨会话仍可看到收藏；重复点击不会产生重复数据。

#### F. 观影历史（按时间倒序 + 一键续看）
- 需求点：
  - 查看历史记录按时间倒序；支持一键续看。
- 设计要点：
  - 触发时机：以“开始播放/播放中更新进度”为主；若播放能力暂不可用，可定义“进入详情页即记录浏览历史”作为过渡方案，但需明确在验收口径中区分“浏览历史 vs 观影历史”。
  - 数据字段：至少包含用户、电影、最后观看时间、观看进度（秒或百分比）、总时长（可选）。
  - 隐私：历史记录仅本人可见。
- 验收口径：
  - 历史列表顺序正确；点击续看能跳转到播放页并从指定进度开始（若播放未落地，则续看入口需明确不可用或跳转到详情并提示）。

#### G. 评论与评分（发布/展示/交互 + 最小审核机制）
- 需求点：
  - 用户可对看过的电影评论与评分；支持点赞/回复；需要不当言论过滤与审核机制。
- 设计要点（建议最小可用版本）：
  - 发布权限：建议与“是否产生观影历史”绑定（至少看过/打开播放过才允许评论），避免灌水。
  - 内容安全：后端进行输入清洗与长度限制；前端渲染走安全策略，避免 XSS。
  - 审核策略（最小实现）：引入状态机（待审/通过/驳回）；对外仅展示“通过”的内容；本人可看到自己的待审内容。
  - 点赞/回复：先实现点赞（低成本）；回复可作为增强项。
- 验收口径：
  - 用户可评分并发布评论；列表展示按时间排序且分页；非法内容被拒绝或进入待审；他人不可见未通过内容。

#### H. 观看电影（在线播放/下载）与版权合规（若资源具备则落地）
- 需求点：
  - 支持在线播放与离线下载；播放流畅，适配不同网络；确保授权合规。
- 设计要点：
  - 数据来源：明确视频资源的存储方式（本地文件/对象存储/外链）与授权证明；为演示可使用开源或可公开播放的样例资源，并在文档中留存来源说明。
  - 播放体验：支持基础控制（播放/暂停/进度/全屏）；弱网下的缓冲提示；失败重试与错误文案。
  - 安全：下载链接可做鉴权与时效控制；播放链接避免被任意用户直接枚举。
- 验收口径：
  - 可从详情页进入播放；播放过程中可记录进度；支持下载入口（若实现）。

#### I. 搜索增强（多维筛选 + 自动补全）
- 需求点：
  - 支持关键词、类型、导演/主演、年份等条件组合搜索；提供智能提示/自动补全。
- 设计要点：
  - 搜索接口：支持多参数组合；明确默认排序规则（相关性/时间/热度）。
  - 自动补全：基于标题/主演等字段提供前缀匹配；需限流与最小输入长度，避免成为热点压测入口。
- 验收口径：
  - 多条件组合可正确过滤；自动补全在合理延迟内返回并可点击填充。

#### J. 推荐（最小可行的个性化）
- 需求点：
  - 根据用户观影历史与偏好推荐电影。
- 设计要点（先落地“可解释的轻量推荐”）：
  - 基于历史/收藏：统计用户常看分类/演员，推荐同类内容。
  - 基于相似：详情页提供“同分类/相近热度”的相关推荐（前端已有雏形，但需基于真实规则与接口）。
  - 约束：保证推荐结果稳定、可解释、可测试；避免引入复杂大数据依赖。
- 验收口径：
  - 新用户有默认推荐；老用户推荐与其收藏/历史存在可解释关联；接口稳定可回归。

### 接口与数据模型（只描述契约，不给代码/脚本）
为避免“前端补 UI、后端补接口”反复返工，先冻结最小契约。以下为建议契约（可在评审后最终定版）：

1) 账号与安全
- 注册：新增邮箱校验与注册入参支持邮箱；提供“用户名可用性检查”“邮箱可用性检查”。
- 登录：支持 identifier（用户名/邮箱）+ 密码；若启用 2FA，返回挑战态并要求提交一次性验证码。
- 找回密码：提供“发起重置”“提交新密码”两个动作，令牌短时有效且一次性。
- 2FA：提供“开启/关闭/获取启用信息（例如二维码内容/恢复码）/验证一次性码”。

2) 用户资料
- 提供“获取我的资料”“更新我的资料”的接口语义；敏感字段（密码、2FA secret 等）不得在普通资料接口透出。

3) 收藏、历史、评论评分
- 收藏：按当前用户维度的“列表/添加/取消”。
- 历史：按当前用户维度的“列表/更新进度/清空（可选）”。
- 评论评分：按电影维度的“分页列表”；按当前用户维度的“新增/删除（可选）/点赞（可选）/回复（可选）”；审核状态控制对外可见性。

4) 观影
- 播放资源获取：按电影维度返回“播放地址/清晰度列表（可选）/字幕（可选）/总时长（可选）”；并与历史进度联动。
- 下载资源获取：按电影维度返回“下载地址/文件信息（可选）”，并考虑鉴权与时效。

5) 搜索与推荐
- 搜索：支持多参数组合；自动补全接口单独提供且带限流策略。
- 推荐：提供“首页推荐/详情相关推荐”两类接口（或统一接口加场景参数）。

### 步骤（按可独立验证拆分）
1. 需求对齐与契约评审：冻结本任务的“功能范围、接口契约、数据模型、验收口径、测试口径”。
2. 账号与安全一期：邮箱唯一性 + 用户名/邮箱登录 + 登录失败限制（不含 2FA/找回密码）。
3. 账号与安全二期：找回密码闭环 + 2FA 闭环（含前端交互与异常提示）。
4. 越权修复：个人资料改为“仅本人”接口语义；前端路由与页面联动调整。
5. 收藏改造：收藏与用户绑定、幂等、状态联动（并完成数据迁移策略说明与回归）。
6. 历史能力：历史记录产生、展示、续看入口（与播放能力联动或过渡方案）。
7. 评论评分：发布/展示/分页/状态机（最小审核策略），并完成基础交互（点赞/回复作为增强项）。
8. 播放与下载：若资源具备则落地播放与下载；否则冻结接口与 UI 占位，确保不阻塞前述闭环。
9. 搜索增强与推荐：多条件搜索 + 自动补全 + 推荐接口与前端呈现。
10. 测试体系收口：补齐自动化测试、E2E 用例与手工回归清单；形成“发布前必跑流程”。

## 过程验证（严密测试流程，对齐步骤）

### 0) 测试总原则（必须遵守）
- 测试分层：单元测试（逻辑）-> 集成测试（接口/鉴权/DB）-> 端到端验证（关键路径）-> 手工回归（兜底）。
- 关键风险优先：越权、认证绕过、密码/令牌安全、数据隔离、接口幂等性为最高优先级。
- 可重复：测试数据准备、用例执行步骤、期望结果必须可复现、可记录。
- 不引入真实外部依赖：邮箱/短信等外部依赖必须可被替身或可观测方式替代，避免测试不稳定。

### 1) 需求对齐与契约评审（步骤 1）
- 验证点：
  - 所有“用户侧未完成能力”在本任务中是否已明确：包含/不包含、MVP/增强项边界、验收口径。
  - 接口契约与数据模型是否足以支持前端交互与测试写法。
- 观察/指标：
  - 评审纪要（包含决策、风险点、分阶段交付列表）。
  - 用例清单（至少覆盖账号安全、越权、收藏/历史/评论的主流程与异常）。
- 通过标准：
  - 评审结论可落地；无关键项“后补再说”；验收口径可操作且可测试。

### 2) 账号与安全一期（步骤 2）
- 自动化测试（后端为主）：
  - 注册：用户名重复、邮箱重复、空值/格式非法、密码不符合强度策略（如有）等用例。
  - 登录（identifier）：用户名登录成功、邮箱登录成功、错误密码失败、未知 identifier 的统一失败提示。
  - 登录失败限制：连续失败达到阈值触发锁定；锁定期间登录行为一致；锁定到期恢复；成功登录清零失败计数。
- 端到端验证（关键路径）：
  - 新用户注册后可以登录；重复注册提示正确；锁定触发后页面提示明确且不泄露敏感信息。
- 通过标准：
  - 失败限制逻辑在可控阈值下稳定触发；错误提示一致；无“可枚举用户名/邮箱是否存在”的信息泄露。

### 3) 账号与安全二期（步骤 3）
- 自动化测试：
  - 找回密码：发起重置（无论邮箱是否存在都返回统一响应语义）、令牌过期、令牌重复使用、重置成功后旧密码不可用。
  - 2FA：启用流程校验一次性码；启用后登录必须二次验证；错误一次性码失败；二次验证失败同样受风控限制。
- 端到端验证：
  - 用户可在“安全设置”完成启用 2FA；启用后登录流程出现二次验证页；忘记密码流程能完成闭环。
- 通过标准：
  - 令牌一次性与过期策略生效；2FA 不会导致“无法恢复”的死锁（至少存在恢复码或关闭流程的策略说明并可验证）。

### 4) 越权修复（步骤 4）
- 自动化测试（必须有）：
  - 已登录用户尝试读取他人资料：被拒绝。
  - 已登录用户尝试更新他人资料：被拒绝。
  - 未登录访问个人资料：被拒绝。
  - 更新自己的资料：成功且仅影响本人记录。
- 手工安全回归：
  - 使用浏览器直接修改请求参数（例如替换路径参数/查询参数）尝试越权，观察返回是否一致且无敏感信息泄露。
- 通过标准：
  - 越权路径完全被封堵；响应语义明确；无旁路接口可绕过。

### 5) 收藏改造（步骤 5）
- 自动化测试：
  - 收藏添加幂等：重复添加不产生重复记录。
  - 收藏取消幂等：重复取消不报错且状态正确。
  - 跨用户隔离：A 用户的收藏列表不包含 B 用户的记录。
  - 数据一致性：收藏状态与列表展示一致（必要时验证缓存失效策略）。
- 端到端验证：
  - 电影详情页可收藏/取消；收藏页能看到变更；重新登录后收藏仍存在。
- 通过标准：
  - 隔离正确；状态联动正确；无重复/脏数据。

### 6) 历史能力（步骤 6）
- 自动化测试：
  - 产生历史记录：在定义的触发点产生或更新记录。
  - 顺序：按最后观看时间倒序。
  - 续看：历史条目包含可续看信息（进度不为 0 的条目应有续看入口）。
  - 隐私：跨用户不可见。
- 端到端验证：
  - 看过（或进入播放）后，历史列表出现记录；点击续看进入播放并定位到正确进度（或执行过渡规则）。
- 通过标准：
  - 历史稳定产生；排序正确；续看路径清晰可用。

### 7) 评论评分（步骤 7）
- 自动化测试：
  - 发布：未登录拒绝；未满足“看过”条件拒绝（若启用此规则）；内容长度/敏感词/XSS 字符等被过滤或拒绝。
  - 展示：仅展示“审核通过”；本人可看到自己的“待审”但他人不可见。
  - 分页与排序：分页参数边界；时间倒序或规则化排序一致。
  - 点赞（若实现）：同一用户重复点赞幂等或按设计处理；计数正确。
- 端到端验证：
  - 详情页可看到评论列表；发布后有明确状态反馈（通过/待审）；刷新后仍一致。
- 通过标准：
  - 内容安全与可见性规则严格；分页稳定；无明显刷接口漏洞（基础限流生效）。

### 8) 播放与下载（步骤 8）
- 自动化测试：
  - 播放资源接口鉴权：未登录拒绝（若要求登录）；无权限/无资源时返回明确错误语义。
  - 进度上报：进度更新幂等且不会回退（除非显式允许回退）；异常值（负数/超长）被拒绝或修正。
- 手工体验测试（必须记录）：
  - 正常网速与弱网下播放可用性；加载/缓冲提示；失败重试；全屏与退出播放行为。
  - 下载入口行为（若实现）：文件信息正确；取消下载/重复下载行为符合预期。
- 通过标准：
  - 播放可用、错误可理解、进度可回归；下载行为合规且可控。

### 9) 搜索增强与推荐（步骤 9）
- 自动化测试：
  - 多条件搜索组合：关键词 + 分类 + 年份等组合返回正确集合；空条件/非法条件处理一致。
  - 自动补全：短输入不触发或返回空；长输入返回候选；限流策略生效（避免被当成压测入口）。
  - 推荐：新用户默认推荐非空；有历史/收藏的用户推荐与其偏好相关；推荐结果稳定且可解释（例如同分类占比）。
- 端到端验证：
  - 搜索栏自动补全可用；筛选可用；推荐模块在首页/详情页可见且点击可跳转。
- 通过标准：
  - 搜索正确性与性能在可接受范围；推荐逻辑稳定可回归。

### 10) 测试体系收口（步骤 10）
- 验证点：
  - 后端测试：关键接口覆盖（账号、越权、收藏、历史、评论、播放资源、搜索推荐）齐全；失败时能定位原因。
  - 前端验证：关键路径 E2E 与手工回归清单齐全，且每次发布都能执行并留痕。
  - 回归策略：明确每类变更需要回归的范围与顺序（优先级与阻断标准）。
- 观察/指标：
  - 测试用例统计与覆盖范围说明（按模块与风险点列出）。
  - 缺陷记录：至少包含复现步骤、期望/实际、影响面、修复验证记录。
- 通过标准：
  - 测试流程可在“新环境/新成员”情况下复现；可形成稳定发布前检查清单。

## 最终结果验证（验收）
- 验收项（用户侧）：
  - 注册：邮箱唯一性校验生效；错误提示清晰。
  - 登录：用户名/邮箱登录可用；失败限制与锁定策略生效；2FA（可选）可用。
  - 找回密码：闭环可用且安全策略生效。
  - 个人资料：仅本人可读可改；无越权。
  - 收藏：按用户隔离；幂等；跨会话持久化。
  - 历史：按时间倒序；具备续看入口（按实现口径）。
  - 评论评分：可发布与展示（含状态机）；内容安全策略生效。
  - 播放/下载：若资源具备则可用并与历史联动；否则接口与 UI 占位不阻塞主链路。
  - 搜索增强与推荐：多维搜索与自动补全可用；推荐可用且可解释。
- 通过标准：
  - 以上验收项全部通过；关键安全项（越权/认证绕过/令牌安全）零容忍。
- 回归范围：
  - 账号相关全链路（注册/登录/找回/2FA）。
  - 鉴权与数据隔离（资料/收藏/历史/评论）。
  - 电影列表/详情/搜索/推荐的主要用户路径。

## 风险与回滚
- 风险点：
  - 数据库唯一约束与历史数据兼容；密码哈希策略升级导致老用户登录失败；风控策略过严导致误伤；2FA 恢复路径不当导致账号无法找回；评论功能引入 XSS/注入风险；播放资源不可控导致验收不可测。
- 规避手段：
  - 分阶段上线；对高风险改动提供兼容策略与灰度开关（例如 2FA 可选启用、风控阈值可配置）；引入统一错误码与文案策略；对评论内容做服务端清洗与前端安全渲染策略。
- 回滚策略（描述思路即可）：
  - 账号与风控：提供关闭/降级开关（例如关闭 2FA 强制、放宽锁定策略）；必要时回退到“仅用户名登录”。
  - 数据模型：对新表/新字段设计为可旁路不影响核心链路；迁移策略可逆（至少可保留旧数据并不删除）。

## 里程碑 / 截止时间
- 开始：2026-01-17
- 截止（建议分段验收，避免一次性大爆炸）：
  - M1（账号与安全一期 + 越权修复）：2026-01-24
  - M2（找回密码 + 2FA + 收藏改造）：2026-01-31
  - M3（历史 + 评论评分 MVP）：2026-02-07
  - M4（播放/下载 + 搜索增强 + 推荐）：2026-02-14

## 关联信息
- 对应 Issue：待补充
- 相关 PR：待补充
- 参考文档：
  - `docs/FEATURES_IMPLEMENTED_CHECKLIST.md`（需求对照清单）

