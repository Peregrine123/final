# TASK-017 影片界面重复项问题排查与修复计划

## 任务内容
- 要做什么：
  - 确认“影片界面出现重复项”的问题是否真实存在、出现在哪些页面/操作路径下，并定位重复来源（数据层/接口层/前端渲染层）。
  - 给出可落地的修复方案（含短期止血与长期根治）以及验证/回归口径。
- 为什么要做（背景/问题）：
  - 用户侧反馈在影片列表/影片展示区域存在“同一影片重复出现”的现象，影响浏览体验与数据可信度；若源于数据写入，会持续污染数据库。
- 目标（可量化）：
  - 任一“影片展示列表”在同一查询条件下，按 `movie.id` 维度严格唯一（不允许同 id 重复渲染/重复返回）。
  - 若产品侧定义“同一影片不可重复录入”，则在“新增/导入”路径上做到可解释的防重策略（提示/合并/禁止）。
- 范围（包含/不包含）：
  - 包含：影库列表（`/library`）、电影管理（`/admin/libraryManagement`）、个人中心相关列表（收藏/想看/看过：`/collectionManagement`）、详情页相关推荐（`/MovieDetails/:id`）。
  - 不包含：推荐算法本身的质量（仅保证不重复）；历史脏数据的人工修复（本任务只给出可执行清洗策略与回滚方案）。
- 影响面（模块/接口/数据/用户）：
  - 前端：`blc-vue/src/components/library/*` 的列表渲染与数据加载逻辑。
  - 后端：`/api/movies`、`/api/categories/{cid}/movies`、`/api/search` 以及用户行为相关接口的返回一致性。
  - 数据：`movie` 表（以及可能的用户行为关联表）是否存在重复记录/缺少唯一性约束。

## 现状与初步排查结论（需要复现补充）
- 代码路径上，影库列表数据来源统一为后端接口返回（前端为“覆盖赋值”模式），未看到显式“追加合并导致重复”的写法。
- 在当前开发库中对 `movie` 表做了基于标题的重复性核查，未发现明显的“同名重复行”；因此若界面仍出现重复，更可能属于：
  1) 特定操作链路导致的“重复写入”后数据污染（与现有库数据不同）；或
  2) 接口层/前端渲染层的重复展示（例如并发请求、组件重复挂载、列表去重缺失等）。
- 结论：需要先把“复现步骤 + 重复判定口径（按 id / 按标题+日期等）”固化下来，再进入定点修复。

## 具体实施方案
说明将采用的技术思路与关键决策：本问题按“先证据、后修复”的流程推进，先锁定重复发生的层级，再选择最小改动的止血方案与长期根治方案。

### 1) 复现与问题定界（必须先完成）
1. 明确发生页面：
   - 影库列表（`/library`）是否重复；
   - 管理端电影表格（`/admin/libraryManagement`）是否重复；
   - 个人中心：收藏/想看/看过列表（`/collectionManagement`）是否重复；
   - 详情页相关推荐是否重复。
2. 明确触发操作：
   - 首次进入即重复 / 切换分类后重复 / 搜索输入过程中重复 / 翻页后重复 / 返回上一页后重复 / 刷新后重复。
3. 明确重复判定口径（按优先级）：
   - **口径 A（强一致）**：同一列表中出现相同 `movie.id` 的多条卡片/行。
   - **口径 B（弱一致）**：`title + date + press` 等核心字段相同但 `id` 不同（疑似重复录入）。
4. 固化证据：
   - 截图 + 记录重复项的 `id/title/date`；
   - 同步记录当时所用的筛选条件（分类 id、关键词、分页页码）。

### 2) 数据层排查（判断是否“重复写入”）
1. 对 `movie` 表按 `id` 唯一性做核查（理论上应天然唯一，重点看是否存在脏数据/异常导入）。
2. 对 `movie` 表按“弱一致口径（如 `title + date` 或 `title + date + press`）”聚合，确认是否存在重复录入。
3. 若确认存在重复录入：
   - 追溯来源：管理端新增/编辑是否将“编辑”误走成“新增”；是否存在导入脚本/批量操作重复执行。
   - 形成清洗策略：保留哪一条为主记录、其余记录如何处理（删除/合并/下线）。

### 3) 接口层排查（判断是否“重复返回”）
1. 对以下接口在同一条件下的返回做“按 `id` 去重前后数量对比”：
   - `/api/movies`
   - `/api/categories/{cid}/movies`
   - `/api/search`
2. 若接口返回中出现相同 `id` 重复：
   - 优先定位 DAO/查询是否存在联表导致重复行（缺少 `distinct`/错误的 join 策略）。
   - **止血策略（后端）**：在服务层对返回列表按 `id` 做去重与稳定排序，避免前端渲染重复。

### 4) 前端渲染层排查与止血（判断是否“重复渲染”）
1. 排查组件是否存在重复挂载/重复渲染：
   - `LibraryIndex.vue` / `MoviesDefault.vue` / `LibraryManagement.vue` / `CollectionManagement.vue` 的生命周期与路由复用逻辑。
2. 排查并发请求导致的状态竞争：
   - 搜索框输入触发频率高时，是否可能出现“旧请求后返回覆盖新请求”或“同一结果重复设置”带来的展示异常。
3. **止血策略（前端）**：
   - 在接收电影列表数据时统一按 `movie.id` 做去重（并保持排序稳定），即使后端偶发重复也不影响 UI。

### 5) 根治方案（按问题归因选择其一或组合）
- 若根因是“重复录入（业务层面不希望重复）”：
  - 定义唯一键口径（例如 `title + date`），并在新增/导入时做存在性检查：提示用户选择“覆盖更新/取消创建”。
  - 评审后决定是否在数据库层增加唯一性约束（并提供存量数据清洗与回滚方案）。
- 若根因是“接口重复返回”：
  - 修正查询（`distinct`/重构联表/调整 ORM 映射），并补齐回归用例覆盖“同 movie 不重复返回”。
- 若根因是“前端重复渲染/状态竞争”：
  - 优化触发链路（例如搜索输入做节流/防抖、请求取消/序列化），并在 UI 层增加 id 去重作为最终保险。

## 过程验证
1. 复现验证
   - 观察/指标：在已知复现路径下稳定复现重复项；能拿到重复项的 `id/title` 证据。
   - 通过标准：复现步骤可被他人按文档复现，且重复判定口径一致。
2. 分层定位验证
   - 观察/指标：能明确重复发生在“数据/接口/前端渲染”哪一层（或多层叠加）。
   - 通过标准：至少定位到一个可改动点（例如某条写入链路、某个查询、某个前端状态更新点）。
3. 修复有效性验证
   - 观察/指标：同一条件下列表按 `movie.id` 唯一；重复录入路径得到可解释的阻断/合并。
   - 通过标准：目标页面不再出现重复项；回归范围内无新增副作用。

## 最终结果验证
- 验收项：
  - `/library` 影库列表：不重复、分页/筛选/搜索正常。
  - `/admin/libraryManagement` 管理端：新增/编辑不引入重复；列表不重复。
  - `/collectionManagement` 个人中心三列表：不重复、状态与跳转正常。
  - `/MovieDetails/:id` 相关推荐：不重复、跳转正常。
- 通过标准：
  - 任一列表在单次渲染中按 `movie.id` 唯一；若出现“弱一致口径重复”，必须有明确产品规则与处理方式（允许/提示/合并/禁止）。
- 回归范围：
  - 电影列表相关接口与页面；电影新增/编辑；搜索与分类筛选；用户收藏/想看/看过；详情页展示。

## 风险与回滚
- 风险点：
  - 若引入数据库唯一约束，可能因存量重复数据导致迁移失败或线上写入报错。
  - 前端止血去重可能掩盖后端/数据层问题，导致问题长期潜伏。
- 规避手段：
  - 先完成“复现与分层定位”，再决定是否上数据库约束；上线前先做数据清洗预案。
  - 去重作为“最后一道防线”，同时保留日志/监控以便持续发现根因。
- 回滚策略（描述思路即可）：
  - 若新增约束导致写入异常：回退约束（或切换为仅应用层校验），并恢复到“允许重复但 UI 不重复展示”的保底策略。

## 里程碑 / 截止时间
- 开始：2026-01-18
- 截止：2026-01-20（先完成复现与分层定位；修复按根因另定）

## 关联信息
- 对应 Issue：TASK-017
- 相关页面/模块：影库列表、电影管理、个人中心收藏/想看/看过、电影详情页
- 相关接口：`/api/movies`、`/api/categories/{cid}/movies`、`/api/search`、用户行为相关接口

